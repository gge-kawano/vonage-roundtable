<html>
  <head>
    <title>Simple Audio Level</title>

    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opentok-layout-js@3.7.1/opentok-layout.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="audioLevel.js"></script>

    <style>
      .noshow { display: none; }
    </style>
  </head>
  <body style="display: flex; flex-direction: row; width: 100%; height: 100vh;">
    <div id="layoutContainer" style="position: relative; display: flex; flex: 1; height: 100vh"></div>
    <div id="publisherContainer" style="display: none"></div>

    <div style="position: relative; left: 0; top: 0; padding: 16px; display: flex; flex-direction: column; background-color: white; width: 300px;">

      <div style="margin-bottom: 16px;">
        <label for="name">Display Name</label>
        <input type="text" id="name" />
      </div>

      <div id="session-control" style="margin-bottom: 16px;">
        <button onclick="initializeSession()">Connect to Session</button>
      </div>

      <div id="publisher-control" style="margin-bottom: 16px;" hidden>
        <button id="publish-camera" onclick="startCamera()">Publish Camera</button>
        <button id="unpublish-camera" onclick="stopCamera()" disabled>Unpublish Camera</button>
      </div>

      <div id="av-control" style="margin-bottom: 16px;" hidden>
        <input type="checkbox" id="audioDisabled" onchange="toggleAudioDisable()"/>
        <label for="audioDisabled">Disable Audio</label>

        <input type="checkbox" id="videoDisabled" onchange="toggleVideoDisable()"/>
        <label for="videoDisabled">Disable Video</label>
      </div>

      <div id="publisher-level" style="margin-bottom: 16px; color: red;"></div>

      <div>Available Speakers (Check to Pin)</div>
      <div id="speaker-list" style="margin-bottom: 16px; padding: 16px; border: 1px solid #000"></div>
      
      <div>Ordered Speaker Activeness</div>
      <div id="ordered-level" style="margin-bottom: 16px; padding: 16px; border: 1px solid #000"></div>
    </div>

    <script>
      const sessionId = '1_MX40NjQ4MTk4Mn5-MTYwMjAzOTczMTI3M353THJlNUVWRC9lMnhuY3FrZHhOaENuUTR-fg';
      const numberOfActiveSpeakers = 2;

      const otSpeech = OTSpeech({ numberOfActiveSpeakers });
      otSpeech.setOnActiveSpeakerChangeListener(onSpeakerOrderChanged);
      
      let OTSession;
      let cameraPublisher = null;
      let forceAudioOff = false;
      let forceVideoOff = false;

      const audioLevels = {};

      const layoutContainer = document.getElementById("layoutContainer");
      const layout = initLayoutContainer(layoutContainer, {
        fixedRatio: false,
        bigFixedRatio: false,
        bigClass: "big",
      }).layout;

      function handleError(error) {
        console.log(error);
      }

      async function getCredentials(sessionId) {
        try {
          const url = `/token?sessionId=${sessionId}`;
          const response = await fetch(url);
          const data = await response.json();
          return Promise.resolve(data);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function initializeSession() {
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }
          document.getElementById('name').disabled = true;

          // Get Credentials
          const credentials = await getCredentials(sessionId);
          const { apiKey, token } = credentials;

          setInterval(() => {
            const keys = Object.keys(audioLevels);
            for (let i = 0; i < keys.length; i += 1) {
              const key = keys[i];
              const { channel, audioLevel } = audioLevels[key];

              // Update Audio Level to OT Speech
              otSpeech.addAudioLevel(channel.id, audioLevel);
            }
          }, 100);

          OTSession = OT.initSession(apiKey, sessionId);
          console.log('Session Created');

          OTSession.on('streamCreated', (event) => {
            const subscriber = OTSession.subscribe(event.stream, 'layoutContainer', {
              insertMode: 'append',
              fitMode: 'contain',
              nameDisplayMode : 'on',
              width: 640,
              height: 480,
            }, (error) => {
              if (error) {
                return handleError(error);
              }

              // Add Subscriber to OT Speech
              otSpeech.addSubscriber(subscriber);

              // Get Audio Level
              subscriber.on('audioLevelUpdated', (e) => {
                audioLevels[subscriber.id] = {
                  audioLevel: e.audioLevel,
                  channel: subscriber,
                };
              });

              // Adjust Layout
              layout();
            });
            
            console.log(`Received Stream at ${event.stream.videoDimensions.width}x${event.stream.videoDimensions.height}`);
          });

          OTSession.on('streamDestroyed', (event) => {
            console.log('Stream Destroyed');

            // Remove Subscriber from OT Speech
            otSpeech.removeSubscriberByStreamId(event.stream.id);

            // Adjust Layout
            layout();
          });

          OTSession.connect(token, (error) => {
            if (error) {
              handleError(error);
              alert(error.message);
              return;
            }
            
            console.log('Session Ready');
            document.getElementById('session-control').hidden = true;
            document.getElementById('publisher-control').hidden = false;
          });

          return Promise.resolve();
        } catch (error) {
          alert(error.message);
          return Promise.resolve();
        }
        
      }

      function onSpeakerOrderChanged(updatedSpeakers) {
        // Fill Ordered Speaker list
        const orderedLevel = document.getElementById('ordered-level');
        orderedLevel.innerText = updatedSpeakers.map(speaker => {
          let name = 'Unknown';
          if (speaker.type === 'subscriber') {
            name = (speaker.subscriber.stream || {}).name;
          } else if (speaker.type === 'publisher') {
            name = 'Myself'
          }

          return name;
        }).join('\n');

        // Fill Available Speaker List
        const speakerElements = updatedSpeakers.filter(speaker => !(speaker.isSelf))
          .sort((a, b) => (a.subscriber.stream || {}).name.toLowerCase() < (b.subscriber.stream || {}).name.toLowerCase() ? -1 : 1)
          .map((speaker) => {
            const speakerElement = document.createElement('div');

            // Checkbox
            const checkboxElement = document.createElement('input');
            checkboxElement.type = 'checkbox';
            checkboxElement.checked = speaker.pinned;
            checkboxElement.onchange = () => otSpeech.setSpeakerPin(speaker.id, checkboxElement.checked);

            // Checkbox Label
            const labelElement = document.createElement('label');
            labelElement.innerText = ((speaker.subscriber.stream) || {}).name || speaker.id;

            speakerElement.appendChild(checkboxElement);
            speakerElement.appendChild(labelElement);

            return speakerElement;
          });
        const speakerListElement = document.getElementById('speaker-list');
        speakerListElement.innerHTML = '';
        for (let i = 0; i < speakerElements.length; i += 1) {
          const speakerElement = speakerElements[i];
          speakerListElement.appendChild(speakerElement);
        }

        // Hide everyone
        const children = layoutContainer.childNodes;
        for (let i = 0; i < children.length; i += 1) {
          const childElement = children[i];
          childElement.classList.add('noshow');
        }

        // Show non-self active speakers
        const nonSelfSpeakers = updatedSpeakers.filter(speaker => !speaker.isSelf);
        const availableActiveSpeakers = Math.min(nonSelfSpeakers.length, numberOfActiveSpeakers);
        for (let i = 0; i < availableActiveSpeakers; i += 1) {
          const speaker = nonSelfSpeakers[i];
          const speakerElement = document.getElementById(speaker.id);
          speakerElement.classList.remove('noshow');
        }
        layout();

        // Subscribe/Unsubscribe to non-self videos
        for (let i = 0; i < nonSelfSpeakers.length; i += 1) {
          const speaker = nonSelfSpeakers[i];
          const shouldSubscribeToVideo = i < numberOfActiveSpeakers;
          speaker.subscriber.subscribeToVideo(shouldSubscribeToVideo);
        }
      }
      
      async function startCamera() {
        stopCamera();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }
          document.getElementById('publish-camera').disabled = true;

          cameraPublisher = OT.initPublisher('publisherContainer', {
            publishAudio: true,
            publishVideo: true,
            fitMode: 'contain',
            insertMode: 'append',
            name,
            style: { nameDisplayMode: "off" }
          }, (error) => {
            if (error) {
              handleError(error);
              return;
            }

            // Add Publisher to OT Speech
            otSpeech.addPublisher(cameraPublisher);

            // Get Audio Level
            cameraPublisher.on('audioLevelUpdated', (e) => {
              audioLevels[cameraPublisher.id] = {
                audioLevel: e.audioLevel,
                channel: cameraPublisher,
              };
              document.getElementById('publisher-level').innerText = `My Audio Level: ${e.audioLevel}`;
            });
            
            // Publish to Session
            OTSession.publish(cameraPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }

              // Adjust Layout
              layout();

              document.getElementById('unpublish-camera').disabled = false;
              document.getElementById('av-control').hidden = false;
            })
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopCamera() {
        if (cameraPublisher != null) {
          // Rmoeve Publisher from OT Speech
          otSpeech.removePublisherByStreamId(cameraPublisher.streamId);

          OTSession.unpublish(cameraPublisher);
          cameraPublisher = null;

          layout();
        }

        document.getElementById('publish-camera').disabled = false;
        document.getElementById('unpublish-camera').disabled = true;
        document.getElementById('av-control').hidden = true;
      }

      function toggleAudioDisable(e) {
        const checkbox = document.getElementById('audioDisabled');
        forceAudioOff = checkbox.checked;
        const shouldEnableAudio = !forceAudioOff;
        cameraPublisher.publishAudio(shouldEnableAudio);
      }

      function toggleVideoDisable(e) {
        const checkbox = document.getElementById('videoDisabled');
        forceVideoOff = checkbox.checked;
        const shouldEnableVideo = !forceVideoOff;
        cameraPublisher.publishVideo(shouldEnableVideo);
      }

    </script>
  </body>
</html>