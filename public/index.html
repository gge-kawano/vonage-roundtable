
<html>
  <head>
    <title>Simple Audio Level</title>

    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="audioLevel.js"></script>
    <script src="layout.js"></script>

    <style>
      body, div {
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        margin: 0;
      }
    </style>
    <link rel="stylesheet" href="volta.min.css">
  </head>
  <body style="display: flex; flex-direction: row; width: 100%; height: 100vh;">
    <div style="position: relative; display: flex; flex: 1; height: 100vh; flex-direction: column; background-color: black; overflow-y: scroll;">
      <div id="screenContainer" style="position: relative; display: flex; width: 100%; height: auto; background-color: black;"></div>
      <div id="layoutContainer" style="position: relative; display: flex; width: 100%; height: 100vh; background-color: black;"></div>
    </div>

    <div style="display: flex; flex-direction: column; width: 300px; padding: 16px; overflow-y: scroll; background-color: #e6e6e6;">
      <div class="Vlt-sidenav__block Vlt-sidenav__block--logo">
        <img class="Vlt-sidenav__elem--full" src="vonage-logo.svg"/>
      </div>

      <div style="width: 100%">
        <div id="publisherContainer" style="margin-bottom: 16px;"></div>
        <div id="publisherContainerScreen" style="margin-bottom: 16px; display: none;"></div>

        <div class="Vlt-form__element">
          <label for="name" class="Vlt-label">Display Name</label>
          <div class="Vlt-input">
            <input type="text" id="name" />
          </div>
        </div>

        <div id="session-control" style="margin-bottom: 16px;">
          <button id="connect" class="Vlt-btn Vlt-btn--primary" onclick="initializeSession()">Connect to Session</button>
        </div>

        <div id="publisher-control" style="margin-bottom: 16px;" hidden>
          <label>Camera</label>
          <div style="margin-bottom: 8px;">
            <button id="publish-camera" class="Vlt-btn Vlt-btn--small Vlt-btn--secondary" onclick="startCamera()">Publish</button>
            <button id="unpublish-camera" class="Vlt-btn Vlt-btn--small Vlt-btn--destructive" onclick="stopCamera()" disabled>Unpublish</button>
          </div>

          <label>Screen</label>
          <div>
            <button id="publish-screen" class="Vlt-btn Vlt-btn--small Vlt-btn--secondary" onclick="startScreen()">Publish</button>
            <button id="unpublish-screen" class="Vlt-btn Vlt-btn--small Vlt-btn--destructive" onclick="stopScreen()" disabled>Unpublish</button>
          </div>
        </div>

        <div id="av-control" style="margin-bottom: 16px;" hidden>
          <label for="name" class="Vlt-label">Audio/Video Control</label>
          <div style="margin-bottom: 16px;">
            <button id="cycle-camera" class="Vlt-btn Vlt-btn--small Vlt-btn--secondary" onclick="cycleCamera()">Cycle Camera</button>
          </div>

          <div class="Vlt-checkbox">
            <label for="audioDisabled">
              <span class="Vlt-checkbox__button">
                <input type="checkbox" id="audioDisabled" onchange="toggleAudioDisable()"/>
                <span class="Vlt-checkbox__icon"></span>
              </span>
              <label for="audioDisabled">Disable Audio</label>
            </label>
          </div>

          <div class="Vlt-checkbox">
            <label for="videoDisabled">
              <span class="Vlt-checkbox__button">
                <input type="checkbox" id="videoDisabled" onchange="toggleVideoDisable()"/>
                <span class="Vlt-checkbox__icon"></span>
              </span>
              <label for="videoDisabled">Disable Video</label>
            </label>
          </div>
        </div>

        <div id="highlight-control" style="margin-bottom: 16px;">
          <div class="Vlt-checkbox">
            <label for="videoDisabled">
              <span class="Vlt-checkbox__button">
                <input type="checkbox" id="highlightEnabled" onchange="toggleHighlightEnabled()" checked />
                <span class="Vlt-checkbox__icon"></span>
              </span>
              <label for="highlightEnabled">Enable Speaker Highlight</label>
            </label>
          </div>
        </div>
        </div>

        <div id="speaker-control" style="margin-bottom: 16px;">
          <label for="name" class="Vlt-label">Speaker Control</label>
          <span>Max Active Speakers:</span>
          <span id="numberOfActiveSpeakersText" style="margin-left: 4px;">2</span>
        </div>
        <input id="numberOfActiveSpeakers" style="margin-bottom: 16px; width: 100%; "
          type="range" min="1" max="20" value="2" class="slider"
          onchange="changeNumberOfActiveSpeakers()"
          oninput="changeNumberOfActiveSpeakersText()" />

        <div>Pin Speakers</div>
        <div id="speaker-list" style="margin-bottom: 16px; padding: 16px; border: 1px solid #c2c4cc; border-radius: 5px; background-color: #fff;"></div>
      </div>
    </div>

    <script>
      const initialNumberOfActiveSpeakers = 2;
      const publisherResolution = { width: 640, height: 480 };
      const subscriberResolution = { width: 640, height: 480 };
      const insertDefaultUI = true; // Whether to use default UI from Opentok or add manually
      const layoutContainer = document.getElementById("layoutContainer");

      const { adjustLayout, enableHighlight, updateHighlight } = OTLayout(layoutContainer);
      const otSpeech = OTSpeech({ numberOfActiveSpeakers: initialNumberOfActiveSpeakers });
      otSpeech.setOnActiveSpeakerChangeListener(onSpeakerOrderChanged);
      otSpeech.setOnMostActiveSpeakerChangeListener(onMostActiveSpeakerChanged);


      let OTSession;
      let cameraPublisher = null;
      let screenPublisher = null;

      function handleError(error) {
        console.log(error);
      }

      async function getCredentials() {
        try {
          const url = `/token`;
          const response = await fetch(url);
          const data = await response.json();
          return Promise.resolve(data);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function initializeSession() {
        try {
          // Disable button
          document.getElementById("connect").disabled = true;

          // Check Display Name sanity
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            document.getElementById("connect").disabled = false;
            alert('Please provide a name');
            return;
          }
          document.getElementById('name').disabled = true;

          // Get Credentials
          const credentials = await getCredentials();
          const { apiKey, sessionId, token } = credentials;

          OTSession = OT.initSession(apiKey, sessionId);
          console.log('Session Created');

          OTSession.on('streamCreated', (event) => {
            const layoutContainer = event.stream.videoType === 'screen' ? 'screenContainer' : 'layoutContainer';
            const subscriber = OTSession.subscribe(event.stream, insertDefaultUI ? layoutContainer : null, {
              insertMode: insertDefaultUI ? 'append' : undefined, // not using insert mode for insertDefaultUI true
              fitMode: insertDefaultUI ? 'contain' : undefined, // not using fit mode for insertDefaultUI true
              insertDefaultUI,
              nameDisplayMode : 'on',
              width: event.stream.videoType === 'screen' ? '100%' : 640,
              height: event.stream.videoType === 'screen' ? '100vh' : 480,
              preferredResolution: subscriberResolution,
            }, (error) => {
              if (error) {
                return handleError(error);
              }

              // Add Subscriber to OT Speech
              if (event.stream.videoType !== 'screen') {
                otSpeech.addSubscriber(subscriber);
              }

              // Update Speaker Pins (new joiner)
              updateSpeakerPins()
            });

            // Note: Use this only if InsertDefaultUI is false
            if (!insertDefaultUI) {
              subscriber.on('videoElementCreated', (e) => {
                const videoElement = e.element;
                videoElement.style.width = event.stream.videoType === 'screen' ? '100%' : '100%';
                videoElement.style.height = event.stream.videoType === 'screen' ? 'auto' : '100%';
                videoElement.style.objectFit = 'contain';

                const divElement = document.createElement('div');
                divElement.id = e.target.stream.id;
                divElement.style.margin = 'auto';
                divElement.appendChild(videoElement);

                const layoutContainer = event.stream.videoType === 'screen' ? 'screenContainer' : 'layoutContainer';
                document.getElementById(layoutContainer).appendChild(divElement);
              });
            }
          });

          OTSession.on('streamDestroyed', (event) => {
            console.log('Stream Destroyed');

            // Remove Subscriber from OT Speech
            otSpeech.removeSubscriberByStreamId(event.stream.id);

            // Remove Subscriber div
            const layoutContainer = event.stream.videoType === 'screen' ? 'screenContainer' : 'layoutContainer';
            const containerElement = document.getElementById(layoutContainer);
            const childNodes = containerElement.childNodes;
            for (let i = 0; i < childNodes.length; i += 1) {
              const childNode = childNodes[i];
              if (childNode.id === event.stream.id) {
                // Remove Child Element
                containerElement.removeChild(childNode);
              }
            }

            // Update Speaker Pins (new leaver)
            updateSpeakerPins()
          });

          OTSession.connect(token, (error) => {
            if (error) {
              handleError(error);
              alert(error.message);
              return;
            }
            
            console.log('Session Ready');
            document.getElementById('session-control').hidden = true;
            document.getElementById('publisher-control').hidden = false;

            // Automatically start publishing camera
            startCamera();
          });

          return Promise.resolve();
        } catch (error) {
          alert(error.message);
          return Promise.resolve();
        }
      }

      // This callback/listener will handle the change of speaker order
      // based on the speech detection via audio level
      function onSpeakerOrderChanged(updatedSpeakers, positions, numberOfActiveSpeakers) {
        // Use Subscriber ID for InsertDefaultUI true
        // Use Stream ID for InsertDefaultUI false
        const mappedPositions = positions.map(position => insertDefaultUI ? otSpeech.getSubscriberIdByStreamId(position) : position);
        adjustLayout(mappedPositions, numberOfActiveSpeakers);
      }

      // This callback/listener will handle the most active speaker changed event
      // which is used to update the speaker highlight
      function onMostActiveSpeakerChanged(mostActiveSpeakerId) {
        // Use Subscriber ID for InsertDefaultUI true
        // Use Stream ID for InsertDefaultUI false
        const mappedId = insertDefaultUI ? otSpeech.getSubscriberIdByStreamId(mostActiveSpeakerId) : mostActiveSpeakerId;
        updateHighlight(mappedId);
      }
      
      async function startCamera() {
        stopCamera();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }
          document.getElementById('publish-camera').disabled = true;

          cameraPublisher = OT.initPublisher('publisherContainer', {
            publishAudio: true,
            publishVideo: true,
            fitMode: 'contain',
            insertMode: 'append',
            name,
            width: '100%',
            resolution: `${publisherResolution.width}x${publisherResolution.height}`,
          }, (error) => {
            if (error) {
              handleError(error);
              return;
            }
            
            // Publish to Session
            OTSession.publish(cameraPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }

              document.getElementById('unpublish-camera').disabled = false;
              document.getElementById('av-control').hidden = false;
            })
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopCamera() {
        if (cameraPublisher != null) {
          OTSession.unpublish(cameraPublisher);
          cameraPublisher = null;
        }

        document.getElementById('publish-camera').disabled = false;
        document.getElementById('unpublish-camera').disabled = true;
        document.getElementById('av-control').hidden = true;
      }

      function cycleCamera() {
        if (cameraPublisher != null) {
          cameraPublisher.cycleVideo();
        }
      }

      async function startScreen() {
        stopScreen();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }
          document.getElementById('publish-screen').disabled = true;

          screenPublisher = OT.initPublisher('publisherContainerScreen', {
            videoSource: 'screen',
            fitMode: 'contain',
            insertMode: 'append',
            name: `${name}-screen`,
            resolution: '1280x720',
            style: { nameDisplayMode: "off" }
          }, (error) => {
            if (error) {
              handleError(error);
              return;
            }
            
            // Publish to Session
            OTSession.publish(screenPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }

              document.getElementById('unpublish-screen').disabled = false;
            })
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopScreen() {
        if (screenPublisher != null) {
          OTSession.unpublish(screenPublisher);
          screenPublisher = null;
        }

        document.getElementById('publish-screen').disabled = false;
        document.getElementById('unpublish-screen').disabled = true;
      }

      function updateSpeakerPins() {
        // Fill Available Speaker List
        const speakerElements = otSpeech.getOrderedChannels()
          .sort((a, b) => (a.subscriber.stream || {}).name.toLowerCase() < (b.subscriber.stream || {}).name.toLowerCase() ? -1 : 1) // sort by speaker name (case-insensitive)
          .map((speaker) => {
            // Speaker Div
            const speakerElement = document.createElement('div');
            speakerElement.classList.add('Vlt-checkbox');

            // Container Label
            const label1 = document.createElement('label');
            const span1 = document.createElement('span');
            span1.classList.add('Vlt-checkbox__button');

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = speaker.pinned;
            checkbox.onchange = () => otSpeech.setSpeakerPin(speaker.id, checkboxElement.checked); // Update Speaker Pin when check/uncheck

            // Icon
            const span2 = document.createElement('span');
            span2.classList.add('Vlt-checkbox__icon');

            // Value
            const label2 = document.createElement('label');
            label2.innerText = ((speaker.subscriber.stream) || {}).name || speaker.id;

            // Set Hierarchy
            span1.appendChild(checkbox);
            span1.appendChild(span2);
            label1.appendChild(span1);
            label1.appendChild(label2);
            speakerElement.appendChild(label1);

            return speakerElement;
          });
        const speakerListElement = document.getElementById('speaker-list');
        speakerListElement.innerHTML = '';
        for (let i = 0; i < speakerElements.length; i += 1) {
          const speakerElement = speakerElements[i];
          speakerListElement.appendChild(speakerElement);
        }
      }

      function toggleAudioDisable(e) {
        const checkbox = document.getElementById('audioDisabled');
        const shouldEnableAudio = !checkbox.checked;
        cameraPublisher.publishAudio(shouldEnableAudio);
      }

      function toggleVideoDisable(e) {
        const checkbox = document.getElementById('videoDisabled');
        const shouldEnableVideo = !checkbox.checked;
        cameraPublisher.publishVideo(shouldEnableVideo);
      }

      function toggleHighlightEnabled(e) {
        const checkbox = document.getElementById('highlightEnabled');
        const shouldEnableHighlight = checkbox.checked;
        enableHighlight(shouldEnableHighlight);
      }

      function changeNumberOfActiveSpeakersText() {
        const numberOfActiveSpeakers = document.getElementById('numberOfActiveSpeakers').value;
        document.getElementById('numberOfActiveSpeakersText').innerText = numberOfActiveSpeakers;
      }

      function changeNumberOfActiveSpeakers() {
        const numberOfActiveSpeakers = document.getElementById('numberOfActiveSpeakers').value;
        otSpeech.setNumberOfActiveSpeakers(numberOfActiveSpeakers);
      }
      

    </script>
  </body>
</html>