<html>
  <head>
    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opentok-layout-js@3.7.1/opentok-layout.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="audioLevel.js"></script>
  </head>
  <body>
    <div style="margin-left: 16px; margin-right: 16px; display: flex; flex-direction: column;">
      <div id="session-control" style="margin-bottom: 16px;">
        <button onclick="initializeSession()">Connect</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <button onclick="startCamera()">Publish Camera</button>
        <button onclick="stopCamera()">Unpublish Camera</button>
      </div>

      <div id="publisher-level" style="margin-bottom: 16px; color: red;">

      </div>
      <div id="subscriber-level" style="margin-bottom: 16px; display: none;">

      </div>
      
      <div>Ordered Audio Level</div>
      <div id="ordered-level" style="margin-bottom: 16px; padding: 16px; border: 1px solid #000"></div>
    </div>
    
    <div id="layoutContainer" style="position: relative; display: flex; flex: 1; height:  100vh"></div>

    <script>
      let OTSession;

      const otSpeech = OTSpeech();
      
      let cameraPublisher = null;

      const layoutContainer = document.getElementById("layoutContainer");
      const layout = initLayoutContainer(layoutContainer, {
        animate: {
          duration: 500,
          easing: 'swing',
        },
        fixedRatio: false,
        bigFixedRatio: false,
        bigClass: "big",
      }).layout;

      function handleError(error) {
        console.log(error);
      }

      function initializeSession() {
        const apiKey = '46481982';
        const sessionId = '1_MX40NjQ4MTk4Mn5-MTYwMjAzOTczMTI3M353THJlNUVWRC9lMnhuY3FrZHhOaENuUTR-fg';
        const token = 'T1==cGFydG5lcl9pZD00NjQ4MTk4MiZzaWc9ZWM5YzMyZGU1YmNlNTAwY2FkYzU4OTI4MzU4MGM3M2MxZTNmOGIyOTpzZXNzaW9uX2lkPTFfTVg0ME5qUTRNVGs0TW41LU1UWXdNakF6T1Rjek1USTNNMzUzVEhKbE5VVldSQzlsTW5odVkzRnJaSGhPYUVOdVVUUi1mZyZjcmVhdGVfdGltZT0xNjAyMjA5ODkzJm5vbmNlPTAuMzE4NzcyNTk1NzM3ODA4MjUmcm9sZT1wdWJsaXNoZXImZXhwaXJlX3RpbWU9MTYwMjI5NjI5MyZpbml0aWFsX2xheW91dF9jbGFzc19saXN0PQ==';

        OTSession = OT.initSession(apiKey, sessionId);
        console.log('Session Created');
        
        OTSession.on('streamCreated', (event) => {
          const subscriber = OTSession.subscribe(event.stream, 'layoutContainer', {
            insertMode: 'append',
            fitMode: 'contain',
            width: 640,
            height: 480,
          }, (error) => {
            if (error) {
              return handleError(error);
            }

            // Add Subscriber to OT Speech
            otSpeech.addSubscriber(subscriber);

            // Get Audio Level
            subscriber.on('audioLevelUpdated', (e) => {
              document.getElementById('subscriber-level').innerText = `${subscriber.id} ${e.audioLevel}`;

              // Update Audio Level to OT Speech
              otSpeech.addAudioLevel(subscriber.id, e.audioLevel);
              updateSpeakers();
            });

            // Adjust Layout
            layout();
          });
          
          console.log(`Received Stream at ${event.stream.videoDimensions.width}x${event.stream.videoDimensions.height}`);
        });

        OTSession.on('streamDestroyed', (event) => {
          console.log('Stream Destroyed');

          // Remove Subscriber from OT Speech
          otSpeech.removeSubscriberByStreamId(event.stream.id);

          // Adjust Layout
          layout();
        });
        
        OTSession.connect(token, (error) => {
          if (error) {
            handleError(error);
            alert(error.message);
            return;
          }
          
          console.log('Session Ready');
          document.getElementById('session-control').hidden = true
        });
      }

      function onSpeakerOrderChanged(updatedSpeakers) {
        for (let i = 0; i < updatedSpeakers.length; i += 1) {
          const speaker = updatedSpeakers[i];
          const channelElement = document.getElementById(speaker.id);
          
          channelElement.classList.add('big');
          if (i !== 0) {
            channelElement.classList.remove('big');
          }
        }
        layout();
      }

      function updateSpeakers() {
        const speakers = otSpeech.getOrderedChannels()
          .map(speaker => ({
            id: speaker.id,
            isSelf: speaker.isSelf,
            audioLevel: speaker.movingAverageAudioLevel
          }));

        const orderedLevel = document.getElementById('ordered-level');
        orderedLevel.innerText = speakers.map(speaker => `${speaker.id}${speaker.isSelf ? ' (self)' : ''}: ${speaker.audioLevel}`).join('\n');
      }
      
      async function startCamera() {
        stopCamera();
        try {
          cameraPublisher = OT.initPublisher('layoutContainer', {
            publishAudio: true,
            publishVideo: true,
            fitMode: 'contain',
            insertMode: 'append',
            width: 640,
            height: 480,
          }, (error) => {
            if (error) {
              handleError(error);
              return;
            }

            // Add Publisher to OT Speech
            otSpeech.addPublisher(cameraPublisher);

            // Get Audio Level
            cameraPublisher.on('audioLevelUpdated', (e) => {
              document.getElementById('publisher-level').innerText = `${cameraPublisher.id} (self) ${e.audioLevel}`;

              // Update Audio Level to OT Speech
              otSpeech.addAudioLevel(cameraPublisher.id, e.audioLevel);
              updateSpeakers();
            });
            
            OTSession.publish(cameraPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }

              // Adjust Layout
              layout();

              setTimeout(() => console.log(`StreamID: ${cameraPublisher.streamId}`), 5000);
            })
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopCamera() {
        if (cameraPublisher != null) {
          // Rmoeve Publisher from OT Speech
          otSpeech.removePublisherByStreamId(cameraPublisher.streamId);

          OTSession.unpublish(cameraPublisher);
          cameraPublisher = null;

          layout();
        }
      }

    </script>
  </body>
</html>