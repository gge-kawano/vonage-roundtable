
<html>
  <head>
    <title>Simple Audio Level</title>

    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="audioLevel.js"></script>
    <script src="layout.js"></script>

    <style>
      body, div {
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        margin: 0;
      }
    </style>
    <link rel="stylesheet" href="volta.min.css">
  </head>
  <body style="display: flex; flex-direction: row; width: 100%; height: 100vh;">
    <div style="position: relative; display: flex; flex: 1; height: 100vh; flex-direction: column; background-color: black; overflow-y: scroll;">
      <div id="screenContainer" style="position: relative; display: flex; width: 100%; height: auto; background-color: black;"></div>
      <div id="layoutContainer" style="position: relative; display: flex; width: 100%; height: 100vh; min-height: 480px; background-color: black;"></div>

      <div id="stream-control" style="width: 100%; position: absolute; z-index: 9999; bottom: 50px; left: 0; right: 0;" hidden>
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
          <button id="button-video-enable" class="Vlt-btn Vlt-btn--large Vlt-btn--primary Vlt-btn--icon" onclick="toggleVideoEnable()">
            <svg><use xlink:href="volta-icons.svg#Vlt-icon-video-negative" /></svg>
          </button>
          <button id="button-audio-enable" class="Vlt-btn Vlt-btn--large Vlt-btn--primary Vlt-btn--icon" onclick="toggleAudioEnable()">
            <svg><use xlink:href="volta-icons.svg#Vlt-icon-microphone-full" /></svg>
          </button>
          <button id="button-screen-share" class="Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" onclick="toggleScreen()">
            <svg><use xlink:href="volta-icons.svg#Vlt-icon-screen-share-full" /></svg>
          </button>
          <button id="button-cycle-camera" class="Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" onclick="cycleCamera()">
            <svg><use xlink:href="volta-icons.svg#Vlt-icon-camera-switch-full" /></svg>
          </button>
        </div>
      </div>

      <div id="sidebar-control" style="position: absolute; right: 20px; top: 20px;">
        <button id="button-collapse-sidebar" class="Vlt-btn Vlt-btn--large Vlt-btn--white Vlt-btn--icon" style="display: block;" onclick="toggleSidebar()">
          <svg><use xlink:href="volta-icons.svg#Vlt-icon-expand" /></svg>
        </button>
        <button id="button-expand-sidebar" class="Vlt-btn Vlt-btn--large Vlt-btn--white Vlt-btn--icon" style="display: none;" onclick="toggleSidebar()">
          <svg><use xlink:href="volta-icons.svg#Vlt-icon-collapse" /></svg>
        </button>
      </div>
    </div>

    <div id="sidebar" style="display: flex; flex-direction: column; width: 400px; height: 100%; padding: 16px; background-color: #e6e6e6;">
      <div class="Vlt-sidenav__block Vlt-sidenav__block--logo">
        <img class="Vlt-sidenav__elem--full" src="vonage-logo.svg"/>
      </div>

      <div style="width: 100%; display: flex; flex-direction: column; flex: 1;">
        <div id="publisherContainerScreen" style="margin-bottom: 16px; display: none;"></div>

        <div id="name-control" class="Vlt-form__element" hidden>
          <label for="name" class="Vlt-label">Display Name</label>
          <div class="Vlt-input">
            <input type="text" id="name" />
          </div>
        </div>

        <div id="session-control" style="margin-bottom: 16px;" hidden>
          <button id="connect" class="Vlt-btn Vlt-btn--primary" onclick="initializeSession()">Connect to Session</button>
        </div>

        <div id="speaker-control" style="margin-bottom: 16px; width: 100%; display: flex; flex-direction: column; flex: 1;" hidden>
          <div class="Vlt-tabs" style="flex: 1; display: flex; flex-direction: column; width: 100%;" >
            <div class="Vlt-tabs__header Vlt-tabs__header--bordered">
              <div class="Vlt-tabs__link Vlt-tabs__link_active"><svg><use xlink:href="volta-icons.svg#Vlt-icon-chat-2"></use></svg><span>Chat</span></div>
              <div class="Vlt-tabs__link"><svg><use xlink:href="volta-icons.svg#Vlt-icon-group-2"></use></svg><span>Participants</span></div>
            </div>
            <div class="Vlt-tabs__content" style="flex: 1;">
              <div class="Vlt-tabs__panel Vlt-tabs__panel_active" style="height: 100%;">
                <div style="width: 100%; display: flex; flex-direction: column; height: 100%">
                  <div style="width: 100%; height: 0px; display: flex; flex: 1; flex-direction: column;">
                    <div id="chat-container" style="width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: scroll;">
                    </div>
                  </div>

                  <div style="width: 100%; padding-top: 32px; padding-bottom: 16px; display: flex; flex-direction: row; align-items: center;">
                    <div class="Vlt-textarea" style="flex: 1; margin-right: 16px;">
                      <textarea rows="1" id="chat-text" placeholder="Type a message" onkeyup="onChatEnter(event)"></textarea>
                    </div>

                    <button id="chat-button" class="Vlt-btn Vlt-btn--large Vlt-btn--secondary Vlt-btn--icon" style="margin: 0;" onclick="sendChat()">
                      <svg><use xlink:href="volta-icons.svg#Vlt-icon-message-read" /></svg>
                    </button>
                  </div>
                  
                </div>
              </div>

              <div class="Vlt-tabs__panel" style="height: 100%;">
                <div id="speaker-list" style="padding: 16px; border: 1px solid #c2c4cc; border-radius: 5px; background-color: #fff;"></div>
              </div>
          
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const initialNumberOfActiveSpeakers = 2;
      const publisherResolution = { width: 640, height: 480 };
      const subscriberResolution = { width: 640, height: 480 };
      const insertDefaultUI = true; // Whether to use default UI from Opentok or add manually
      const layoutContainer = document.getElementById("layoutContainer");

      let { adjustLayout, updateHighlight, addSelfSpeakerId, removeSelfSpeakerId } = OTLayout(layoutContainer);
      let otSpeech = OTSpeech({ numberOfActiveSpeakers: initialNumberOfActiveSpeakers });
      otSpeech.setOnActiveSpeakerChangeListener(onSpeakerOrderChanged);
      otSpeech.setOnMostActiveSpeakerChangeListener(onMostActiveSpeakerChanged);


      let OTSession;
      let tokenParam = null;
      let cameraPublisher = null;
      let screenPublisher = null;

      let enableAudio = true; // Assume not > 16 speakers
      let enableVideo = true; // Assume not > 16 speakers
      let unpublishDelay = 30; // 30s of disable audio + video to consider unpublishing
      let retryCount = 0;
      let retryLimit = 0;


      // Debouncing logic for handling window resize layout adjustment
      let notifySpeakerChangeTimeout = null;
      function notifySpeakerChange() {
        // Clear timeout if exist
        if (notifySpeakerChangeTimeout != null) {
          clearTimeout(notifySpeakerChangeTimeout);
        }

        // Set new timeout for actual adjustment
        notifySpeakerChangeTimeout = setTimeout(() => otSpeech.notifySpeakerChange(), 500);
      }
      // Listen for Window Resize
      window.addEventListener('resize', () => notifySpeakerChange());
      
      function waitForReady(callback) {
        /in/.test(document.readyState) ? setTimeout('waitForReady('+callback+')', 9) : callback();
      };

      function getParams() {
        const searchString = window.location.search || '?';
        const query = searchString.slice(1);
        const components = query.split(/&/g);
        const params = {};

        for (let i = 0; i < components.length; i += 1) {
          const component = components[i];
          const splitIndex = component.indexOf('=');
          if (splitIndex >= 0) {
            const rawKey = component.slice(0, splitIndex);
            const rawValue = component.slice(splitIndex + 1);
            console.log(rawKey);
            console.log(rawValue);
            const key = decodeURIComponent(rawKey);
            const value = decodeURIComponent(rawValue);
            params[key] = value;
          }
        }
        return params;
      };

      function handleError(error) {
        console.log(error);
      }

      async function getCredentials() {
        if (tokenParam != null && tokenParam !== '') {
          // Decode Token
          const b64Encoded = tokenParam.slice(4);
          const buffer = atob(b64Encoded);
          const b64Decoded = buffer.toString('ascii');

          // Read Decoded Data for Api Key and Session Id
          const components = b64Decoded.split(/&|:/g);
          const data = {};
          for (let i = 0; i < components.length; i += 1) {
            const component = components[i];
            const firstEqualIndex = component.indexOf('=');
            if (firstEqualIndex <= 0) {
              continue;
            }

            const key = component.slice(0, firstEqualIndex);
            const value = component.slice(firstEqualIndex + 1);
            data[key] = value;
          }

          return Promise.resolve({
            apiKey: data.partner_id,
            sessionId: data.session_id,
            token: tokenParam,
          });
        }
        try {
          const url = `/token`;
          const response = await fetch(url);
          const data = await response.json();
          return Promise.resolve(data);
        } catch (error) {
          console.log(error.message);
          error.code = 1006;
          return Promise.reject(error);
        }
      }

      async function initializeSession() {
        try {
          // Disable button
          document.getElementById("connect").disabled = true;

          // Check Display Name sanity
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            document.getElementById("connect").disabled = false;
            alert('Please provide a name');
            return;
          }
          document.getElementById('name').disabled = true;
          document.getElementById('name-control').hidden = true;

          // Get Credentials
          const credentials = await getCredentials();
          const { apiKey, sessionId, token } = credentials;

          OTSession = OT.initSession(apiKey, sessionId);
          console.log('Session Created');

          OTSession.on('streamCreated', (event) => {
            const layoutContainer = event.stream.videoType === 'screen' ? 'screenContainer' : 'layoutContainer';
            const subscriber = OTSession.subscribe(event.stream, insertDefaultUI ? layoutContainer : null, {
              insertMode: insertDefaultUI ? 'append' : undefined, // not using insert mode for insertDefaultUI true
              fitMode: insertDefaultUI ? 'contain' : undefined, // not using fit mode for insertDefaultUI true
              insertDefaultUI,
              nameDisplayMode : 'on',
              width: event.stream.videoType === 'screen' ? '100%' : 640,
              height: event.stream.videoType === 'screen' ? '100vh' : 480,
              preferredResolution: subscriberResolution,
            }, (error) => {
              if (error) {
                return handleError(error);
              }

              // Add Subscriber to OT Speech
              if (event.stream.videoType !== 'screen') {
                otSpeech.addSubscriber(subscriber);
              }
            });

            // Note: Use this only if InsertDefaultUI is false
            if (!insertDefaultUI) {
              subscriber.on('videoElementCreated', (e) => {
                const videoElement = e.element;
                videoElement.style.width = event.stream.videoType === 'screen' ? '100%' : '100%';
                videoElement.style.height = event.stream.videoType === 'screen' ? 'auto' : '100%';
                videoElement.style.objectFit = 'contain';

                const divElement = document.createElement('div');
                divElement.id = e.target.stream.id;
                divElement.style.margin = 'auto';
                divElement.appendChild(videoElement);

                const layoutContainer = event.stream.videoType === 'screen' ? 'screenContainer' : 'layoutContainer';
                document.getElementById(layoutContainer).appendChild(divElement);
              });
            }
          });

          OTSession.on('streamDestroyed', (event) => {
            console.log('Stream Destroyed');

            // Remove Subscriber from OT Speech
            otSpeech.removeSubscriberByStreamId(event.stream.id);

            // Remove Subscriber div
            const layoutContainer = event.stream.videoType === 'screen' ? 'screenContainer' : 'layoutContainer';
            const containerElement = document.getElementById(layoutContainer);
            const childNodes = containerElement.childNodes;
            for (let i = 0; i < childNodes.length; i += 1) {
              const childNode = childNodes[i];
              if (childNode.id === event.stream.id) {
                // Remove Child Element
                containerElement.removeChild(childNode);
              }
            }
          });

          OTSession.on('sessionDisconnected', (event) => {
            console.log('sessionDisconnected');
            const { reason } = event;
            if (reason === 'networkDisconnected') {
              console.log('Network disconnected, attempting reconnection');
              OTSession.disconnect();
              connect(true);
            }
          });

          OTSession.on('signal', (e) => {
            const { type, data } = e;
            if (type === 'signal:chat') {
              const { name, text } = JSON.parse(data);

              const row = document.createElement('div');
              row.style.width = '100%';
              row.style.display = 'flex';
              row.style.flexDirection = 'row';

              const bubble = document.createElement('div');
              bubble.style.flexDirection = 'column';
              bubble.style.justifyContent = 'center';
              bubble.style.minWidth = '32px';
              bubble.style.maxWidth = '80%';
              bubble.style.paddingLeft = '8px';
              bubble.style.paddingRight = '8px';
              bubble.style.paddingTop = '4px';
              bubble.style.paddingBottom = '4px';
              bubble.style.marginBottom = '8px';
              bubble.style.borderRadius = '16px';
              bubble.style.color = '#ffffff';
              bubble.innerText = text;

              const isSelf = name === document.getElementById('name').value;
              if (isSelf) {
                row.style.flexDirection = 'row-reverse';

                bubble.style.backgroundColor = '#871fff';
              } else {
                bubble.style.backgroundColor = '#767676';
                bubble.innerHTML = '';
                
                const nameDiv = document.createElement('div');
                nameDiv.innerText = name;
                nameDiv.style.fontWeight = 'bold';

                const textDiv = document.createElement('div');
                textDiv.innerText = text;

                bubble.appendChild(nameDiv);
                bubble.appendChild(textDiv);
              }

              row.appendChild(bubble);
              document.getElementById('chat-container').appendChild(row);

              console.log(`${name}${isSelf ? ' (me)' : ''} - ${text}`);
            }
          });

          connect(false);

          return Promise.resolve();
        } catch (error) {
          alert(error.message);
          return Promise.resolve();
        }
      }

      async function connect(retry) {
        try {
          const credentials = await getCredentials();
          OTSession.connect(credentials.token, (error) => {
            if (error) {
              if (retry && error.code == 1006 && (retryLimit === 0 || (retryLimit > 0 && retryCount > 0))) {
                console.log('Will attempt reconnect');
                retryCount -= 1; // Decrease Count
                setTimeout(() => connect(retry), 5000);
                return;
              };
              handleError(error);
              alert(error.message);
              return;
            }

            retryCount = retryLimit; // Reset Count
            
            console.log('Session Ready');
            document.getElementById('session-control').hidden = true;
            document.getElementById('stream-control').hidden = false;
            document.getElementById('speaker-control').hidden = false;
            
            if (enableAudio) {
              document.getElementById('button-audio-enable').classList.remove('Vlt-btn--tertiary');
              document.getElementById('button-audio-enable').classList.add('Vlt-btn--primary');
            } else {
              document.getElementById('button-audio-enable').classList.remove('Vlt-btn--primary');
              document.getElementById('button-audio-enable').classList.add('Vlt-btn--tertiary');
            }
            
            if (enableVideo) {
              document.getElementById('button-video-enable').classList.remove('Vlt-btn--tertiary');
              document.getElementById('button-video-enable').classList.add('Vlt-btn--primary');
            } else {
              document.getElementById('button-video-enable').classList.remove('Vlt-btn--primary');
              document.getElementById('button-video-enable').classList.add('Vlt-btn--tertiary');
            }

            // Automatically start publishing camera
            startCamera();
          });
        } catch (error) {
          if (retry && error.code == 1006 && (retryLimit === 0 || (retryLimit > 0 && retryCount > 0))) {
            console.error(error.message);
            console.log('Will attempt reconnect');
            retryCount -= 1; // Decrease Count
            setTimeout(() => connect(retry), 5000);
            return;
          }
          console.error(error);
        }
      }

      // This callback/listener will handle the change of speaker order
      // based on the speech detection via audio level
      function onSpeakerOrderChanged(updatedSpeakers, positions, numberOfActiveSpeakers) {
        // Use Subscriber ID for InsertDefaultUI true
        // Use Stream ID for InsertDefaultUI false
        const mappedPositions = positions.map(position => insertDefaultUI ? otSpeech.getSubscriberIdByStreamId(position) : position)
          .filter(subscriberId => subscriberId != null);
        adjustLayout(mappedPositions, numberOfActiveSpeakers);
        updateSpeakerPins();
      }

      // This callback/listener will handle the most active speaker changed event
      // which is used to update the speaker highlight
      function onMostActiveSpeakerChanged(mostActiveSpeakerId) {
        // Use Subscriber ID for InsertDefaultUI true
        // Use Stream ID for InsertDefaultUI false
        const mappedId = insertDefaultUI ? otSpeech.getSubscriberIdByStreamId(mostActiveSpeakerId) : mostActiveSpeakerId
          .filter(subscriberId => subscriberId != null);
        updateHighlight(mappedId);
      }

      function toggleCamera() {
        if (cameraPublisher == null) {
          startCamera();
        } else {
          stopCamera();
        }
      }

      function toggleScreen() {
        if (screenPublisher == null) {
          startScreen();
        } else {
          stopScreen();
        }
      }
      
      async function startCamera() {
        stopCamera();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }

          cameraPublisher = OT.initPublisher('layoutContainer', {
            publishAudio: enableAudio,
            publishVideo: enableVideo,
            fitMode: 'contain',
            insertMode: 'append',
            name,
            width: '100%',
            resolution: `${publisherResolution.width}x${publisherResolution.height}`,
          }, (error) => {
            if (error) {
              handleError(error);
              return;
            }

            // Publish to Session
            OTSession.publish(cameraPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }
            });
          });

          cameraPublisher.on('streamCreated', (event) => {
              // Add to screen
              const speakerId = insertDefaultUI ? cameraPublisher.id : event.stream.id;
              addSelfSpeakerId(speakerId);
              otSpeech.addSelf();
              otSpeech.notifySpeakerChange();
          });

          cameraPublisher.on('streamDestroyed', (event) => {
              // Add to screen
              const speakerId = insertDefaultUI ? cameraPublisher.id : event.stream.id;
              removeSelfSpeakerId(speakerId);
              otSpeech.removeSelf();
              otSpeech.notifySpeakerChange();
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopCamera() {
        if (cameraPublisher != null) {
          OTSession.unpublish(cameraPublisher);
          cameraPublisher = null;
        }
      }

      function cycleCamera() {
        if (cameraPublisher != null) {
          cameraPublisher.cycleVideo();
        }
      }

      async function startScreen() {
        stopScreen();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }

          screenPublisher = OT.initPublisher('publisherContainerScreen', {
            videoSource: 'screen',
            fitMode: 'contain',
            insertMode: 'append',
            name: `${name}-screen`,
            resolution: '1280x720',
            style: { nameDisplayMode: "off" }
          }, (error) => {
            if (error) {
              handleError(error);
              return;
            }
            
            // Publish to Session
            OTSession.publish(screenPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }

              document.getElementById('button-screen-share').classList.remove('Vlt-btn--tertiary');
              document.getElementById('button-screen-share').classList.add('Vlt-btn--primary');
            })
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopScreen() {
        if (screenPublisher != null) {
          OTSession.unpublish(screenPublisher);
          screenPublisher = null;
        }

        document.getElementById('button-screen-share').classList.remove('Vlt-btn--primary');
        document.getElementById('button-screen-share').classList.add('Vlt-btn--tertiary');
      }

      function updateSpeakerPins() {
        // Fill Available Speaker List
        const speakerElements = otSpeech.getOrderedChannels()
          .sort((a, b) => {
            // Pinned on top
            if (a.pinned && !b.pinned) {
              return -1;
            } else if (b.pinned && !a.pinned) {
              return 1;
            }

            return (a.subscriber.stream || {}).name.toLowerCase() < (b.subscriber.stream || {}).name.toLowerCase() ? -1 : 1; // sort by speaker name (case-insensitive)
          })
          .map((speaker) => {
            // Speaker Div
            const speakerElement = document.createElement('div');
            speakerElement.style.width = '100%';
            speakerElement.style.display = 'flex';
            speakerElement.style.flexDirection = 'row';
            speakerElement.style.alignItems = 'center';

            // Icon Button
            const iconButton = document.createElement('button');
            iconButton.classList.add('Vlt-btn');
            iconButton.classList.add('Vlt-btn--app');
            iconButton.classList.add('Vlt-btn--icon');
            iconButton.classList.add(speaker.pinned ? 'Vlt-btn--primary' : 'Vlt-btn--tertiary');
            iconButton.style.marginRight = '16px';
            iconButton.style.width = '24px';
            iconButton.style.height = '24px';
            iconButton.style.minWidth = '24px';
            iconButton.style.minHeight = '24px';
            iconButton.style.padding = '2px';
            iconButton.onclick = () => otSpeech.setSpeakerPin(speaker.id, !speaker.pinned);

            // Icon SVG
            const iconElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            iconElement.style.color = '#ff0000';
            iconElement.innerHTML = '<use xlink:href="volta-icons.svg#Vlt-icon-pin-2" />';
            iconElement.style.width = '12px';
            iconElement.style.height = '12px';
            iconButton.appendChild(iconElement);

            // Speaker Name
            const nameElement = document.createElement('label');
            nameElement.innerText = ((speaker.subscriber.stream) || {}).name || speaker.id;

            speakerElement.appendChild(iconButton);
            speakerElement.appendChild(nameElement);
            return speakerElement;
          });

        const speakerListElement = document.getElementById('speaker-list');
        speakerListElement.innerHTML = '';
        for (let i = 0; i < speakerElements.length; i += 1) {
          const speakerElement = speakerElements[i];
          speakerListElement.appendChild(speakerElement);
        }
      }

      function toggleAudioEnable() {
        enableAudio = !enableAudio;
        cameraPublisher.publishAudio(enableAudio);
        
        if (enableAudio) {
          document.getElementById('button-audio-enable').classList.remove('Vlt-btn--tertiary');
          document.getElementById('button-audio-enable').classList.add('Vlt-btn--primary');
        } else {
          document.getElementById('button-audio-enable').classList.remove('Vlt-btn--primary');
          document.getElementById('button-audio-enable').classList.add('Vlt-btn--tertiary');
        }
      }

      function toggleVideoEnable() {
        enableVideo = !enableVideo;
        cameraPublisher.publishVideo(enableVideo);
        
        if (enableVideo) {
          document.getElementById('button-video-enable').classList.remove('Vlt-btn--tertiary');
          document.getElementById('button-video-enable').classList.add('Vlt-btn--primary');
        } else {
          document.getElementById('button-video-enable').classList.remove('Vlt-btn--primary');
          document.getElementById('button-video-enable').classList.add('Vlt-btn--tertiary');
        }
      }

      function toggleSidebar() {
        const sidebarElement = document.getElementById('sidebar');
        sidebarElement.hidden = !sidebarElement.hidden;
        const isHidden = sidebarElement.style.display === 'none';
        if (isHidden) {
          // Unhide
          sidebarElement.style.display = 'flex';
          document.getElementById('button-collapse-sidebar').style.display = 'block';
          document.getElementById('button-expand-sidebar').style.display = 'none';
        } else {
          // Hide
          sidebarElement.style.display = 'none';
          document.getElementById('button-collapse-sidebar').style.display = 'none';
          document.getElementById('button-expand-sidebar').style.display = 'block';
        }
      }

      function onChatEnter(event) {
        if (event.key === 'Enter') {
          if (!event.shiftKey) {
            sendChat();
          }
        }
      }

      function sendChat() {
        const text = document.getElementById('chat-text').value;
        const name = document.getElementById('name').value;

        if (text == null || text === '') {
          return;
        }

        OTSession.signal({
          type: 'chat',
          data: JSON.stringify({
            name,
            text,
          }),
        }, (error) => {
          if (error) {
            console.error(error);
            return;
          }

          // Clear textbox
          document.getElementById('chat-text').value = '';
          console.log('Chat sent');
        });
      }

      waitForReady(() => {
        Volta.init(['tab']);

        const params = getParams();
        let {
          name, token, highlight,
          max, ratio, 
          unpublish_delay, retry_limit,
        } = params;

        const numberOfActiveSpeakers = parseInt((max || '2'), 10);
        const aspectRatio = ratio === '16_9' ? 16 / 9 : 4 / 3;
        highlight = (highlight || 'true').toLowerCase() === 'true';
        tokenParam = token;
        unpublishDelay = parseInt((unpublish_delay || '30'), 10);
        retryLimit = parseInt((retry_limit || '0'), 10);
        retryCount = retryLimit;

        ({ adjustLayout, updateHighlight, addSelfSpeakerId, removeSelfSpeakerId } = OTLayout(layoutContainer, { aspectRatio, highlight }));
        otSpeech = OTSpeech({ numberOfActiveSpeakers });
        otSpeech.setOnActiveSpeakerChangeListener(onSpeakerOrderChanged);
        otSpeech.setOnMostActiveSpeakerChangeListener(onMostActiveSpeakerChanged);

        if (name != null && name != '') {
          document.getElementById('name').value = name;
          document.getElementById('session-control').hidden = true;
          document.getElementById('name-control').hidden = true;
          initializeSession();
        } else {
          document.getElementById('session-control').hidden = false;
          document.getElementById('name-control').hidden = false;
        }
        
      })
    </script>
    
    <script src="volta.min.js"></script>
  </body>
</html>