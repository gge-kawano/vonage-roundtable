<html>
  <head>
    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opentok-layout-js@3.7.1/opentok-layout.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="audioLevel.js"></script>

    <style>
    </style>
  </head>
  <body>
    <div style="margin-left: 16px; margin-right: 16px; display: flex; flex-direction: column;">
      <div id="session-control" style="margin-bottom: 16px;">
        <button onclick="initializeSession()">Connect</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <button onclick="startCamera()">Publish Camera</button>
        <button onclick="stopCamera()">Unpublish Camera</button>
      </div>

      <div style="margin-bottom: 16px;">
        <input type="checkbox" id="audioDisabled" onchange="toggleAudioDisable()"/>
        <label for="audioDisabled">Disable Audio</label>

        <input type="checkbox" id="videoDisabled" onchange="toggleVideoDisable()"/>
        <label for="videoDisabled">Disable Video</label>
      </div>

      <div id="publisher-level" style="margin-bottom: 16px; color: red;">

      </div>
      <div id="subscriber-level" style="margin-bottom: 16px; display: none;">

      </div>
      
      <div>Ordered Audio Level</div>
      <div id="ordered-level" style="margin-bottom: 16px; padding: 16px; border: 1px solid #000"></div>
    </div>
    
    <div id="layoutContainer" style="position: relative; display: flex; flex: 1; height:  100vh"></div>
    <div id="publisherContainer" style="display: none"></div>

    <script>
      let OTSession;
      const numberOfActiveSpeakers = 2;

      const otSpeech = OTSpeech({ numberOfActiveSpeakers });
      otSpeech.setOnActiveSpeakerChangeListener(onSpeakerOrderChanged);
      
      let cameraPublisher = null;
      let forceAudioOff = false;
      let forceVideoOff = false;

      const audioLevels = {};

      const layoutContainer = document.getElementById("layoutContainer");
      const layout = initLayoutContainer(layoutContainer, {
        fixedRatio: false,
        bigFixedRatio: false,
        bigClass: "big",
      }).layout;

      function handleError(error) {
        console.log(error);
      }

      function initializeSession() {
        const apiKey = '46481982';
        const sessionId = '1_MX40NjQ4MTk4Mn5-MTYwMjAzOTczMTI3M353THJlNUVWRC9lMnhuY3FrZHhOaENuUTR-fg';
        const token = 'T1==cGFydG5lcl9pZD00NjQ4MTk4MiZzaWc9YTNiYjkyN2Q4ZDczNWVmYTEwOGM0MmVlNDQ1MjAwNTBkMjg3ZWI1ZjpzZXNzaW9uX2lkPTFfTVg0ME5qUTRNVGs0TW41LU1UWXdNakF6T1Rjek1USTNNMzUzVEhKbE5VVldSQzlsTW5odVkzRnJaSGhPYUVOdVVUUi1mZyZjcmVhdGVfdGltZT0xNjAyNTUzNzM4Jm5vbmNlPTAuNjY3NTQ0MDAxMzkwMjc0MyZyb2xlPXB1Ymxpc2hlciZleHBpcmVfdGltZT0xNjAyNjQwMTM4JmluaXRpYWxfbGF5b3V0X2NsYXNzX2xpc3Q9';

        setInterval(() => {
          const keys = Object.keys(audioLevels);
          for (let i = 0; i < keys.length; i += 1) {
            const key = keys[i];
            const { channel, audioLevel } = audioLevels[key];

            // Update Audio Level to OT Speech
            otSpeech.addAudioLevel(channel.id, audioLevel);
          }
        }, 100);

        OTSession = OT.initSession(apiKey, sessionId);
        console.log('Session Created');
        
        OTSession.on('streamCreated', (event) => {
          const subscriber = OTSession.subscribe(event.stream, 'layoutContainer', {
            insertMode: 'append',
            fitMode: 'contain',
            width: 640,
            height: 480,
          }, (error) => {
            if (error) {
              return handleError(error);
            }

            // Add Subscriber to OT Speech
            otSpeech.addSubscriber(subscriber);

            // Get Audio Level
            subscriber.on('audioLevelUpdated', (e) => {
              audioLevels[subscriber.id] = {
                audioLevel: e.audioLevel,
                channel: subscriber,
              };
            });

            // Adjust Layout
            layout();
          });
          
          console.log(`Received Stream at ${event.stream.videoDimensions.width}x${event.stream.videoDimensions.height}`);
        });

        OTSession.on('streamDestroyed', (event) => {
          console.log('Stream Destroyed');

          // Remove Subscriber from OT Speech
          otSpeech.removeSubscriberByStreamId(event.stream.id);

          // Adjust Layout
          layout();
        });
        
        OTSession.connect(token, (error) => {
          if (error) {
            handleError(error);
            alert(error.message);
            return;
          }
          
          console.log('Session Ready');
          document.getElementById('session-control').hidden = true
        });
      }

      function onSpeakerOrderChanged(updatedSpeakers) {
        const orderedLevel = document.getElementById('ordered-level');
        orderedLevel.innerText = updatedSpeakers.map(speaker => `${speaker.id}${speaker.isSelf ? ' (self)' : ''}`).join('\n');

        // Clear all Big classes
        const children = layoutContainer.childNodes;
        for (let i = 0; i < children.length; i += 1) {
          const childElement = children[i];
          childElement.classList.remove('big');
        }

        // Set Big class for Active Speaker
        for (let i = 0; i < numberOfActiveSpeakers; i += 1) {
          if (i < updatedSpeakers.length) {
            const speaker = updatedSpeakers[i];
            const speakerElement = document.getElementById(speaker.id);
            if (!(speaker.isSelf)) {
              speakerElement.classList.add('big');
            }
          }
        }
        layout();

        for (let i = 0; i < updatedSpeakers.length; i += 1) {
          const speaker = updatedSpeakers[i];
          if (!speaker.isSelf) {
            if (i < numberOfActiveSpeakers) {
              speaker.subscriber.subscribeToVideo(true);
            } else {
              speaker.subscriber.subscribeToVideo(false);
            }
          }
        }
      }
      
      async function startCamera() {
        stopCamera();
        try {
          cameraPublisher = OT.initPublisher('publisherContainer', {
            publishAudio: true,
            publishVideo: true,
            fitMode: 'contain',
            insertMode: 'append',
          }, (error) => {
            if (error) {
              handleError(error);
              return;
            }

            // Add Publisher to OT Speech
            otSpeech.addPublisher(cameraPublisher);

            // Get Audio Level
            cameraPublisher.on('audioLevelUpdated', (e) => {
              audioLevels[cameraPublisher.id] = {
                audioLevel: e.audioLevel,
                channel: cameraPublisher,
              };
              document.getElementById('publisher-level').innerText = `${cameraPublisher.id} (self) ${e.audioLevel}`;
            });
            
            OTSession.publish(cameraPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }

              // Adjust Layout
              layout();

              setTimeout(() => console.log(`StreamID: ${cameraPublisher.streamId}`), 5000);
            })
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopCamera() {
        if (cameraPublisher != null) {
          // Rmoeve Publisher from OT Speech
          otSpeech.removePublisherByStreamId(cameraPublisher.streamId);

          OTSession.unpublish(cameraPublisher);
          cameraPublisher = null;

          layout();
        }
      }

      function toggleAudioDisable(e) {
        const checkbox = document.getElementById('audioDisabled');
        forceAudioOff = checkbox.checked;
        const shouldEnableAudio = !forceAudioOff;
        cameraPublisher.publishAudio(shouldEnableAudio);
      }

      function toggleVideoDisable(e) {
        const checkbox = document.getElementById('videoDisabled');
        forceVideoOff = checkbox.checked;
        const shouldEnableVideo = !forceVideoOff;
        cameraPublisher.publishVideo(shouldEnableVideo);
      }

    </script>
  </body>
</html>